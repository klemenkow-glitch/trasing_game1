<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pustolov≈°ƒçina Sledenja za Malƒçke</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- ODZIVNO OBLIKOVANJE IN PRILAGODITEV --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #eef2ff;
            /* KLJUƒåNO ZA ODZIVNOST: Celoten viewport (100vh) in prepreƒçevanje horizontalnega drsenja */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centriranje vsebine po horizontalni osi */
            overflow-x: hidden; /* **KLJUƒåNO POPRAVILO:** Prepreƒçi horizontalno drsenje */
        }

        /* Vsebnik za celotno vsebino, da se izogne ≈°irjenju na ≈°irino zaslona */
        .main-content-wrapper {
            width: 100%;
            max-width: 1200px; /* Omejitev za zelo ≈°iroke zaslone */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Glavni vsebnik platna (Canvas) */
        .canvas-container {
            position: relative;
            background-color: #ffffff;
            border: 4px solid #4f46e5;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* Ohranitev odliƒçnega kvadratnega razmerja, ki se prilagodi VZDVH in V≈†IRINO */
            width: min(95vh, 95vw);
            max-width: 600px;
            aspect-ratio: 1 / 1;
            margin: 1rem auto;
            touch-action: none;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 2;
        }

        /* Target Display (predloga) - Poveƒçana velikost fonta na mobilnih napravah in zmanj≈°ana na veƒçjih zaslonih */
        #targetDisplay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Prilagajanje velikosti: uporablja relativne vh/vw enote, omejene na max 15rem */
            font-size: min(25vw, 25vh, 15rem); 
            pointer-events: none;
            line-height: 1;
            z-index: 1;
            font-family: 'Inter', sans-serif;
            font-weight: 300;
            -webkit-text-stroke: 1.5px rgba(147, 197, 253, 0.8);
            -webkit-text-fill-color: #FFFFFF;
            color: rgba(147, 197, 253, 0.8);
            text-rendering: optimizeLegibility;
            text-shadow: none;
        }
        
        /* Ostali stili (uspeh, gumbi, ipd.) ostanejo enaki, saj niso kritiƒçni za glavni problem */
        .cursive-font {
            font-family: 'Dancing Script', cursive !important;
            font-weight: 700 !important;
            -webkit-text-stroke: 1px rgba(100, 100, 100, 0.8);
        }

        #successOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #confettiText {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 20px;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        .success-icon { opacity: 0; transition: opacity 0.3s; }
        .success-icon-animate { animation: zoomIn 0.5s forwards; opacity: 1 !important; }
        .rocket-animate { animation: zoomIn 0.5s forwards, rocketLaunch 2s 0.5s forwards; opacity: 1 !important; }
        @keyframes zoomIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes rocketLaunch { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(-200%) rotate(0); opacity: 0; } }

        .confetti {
            position: fixed; /* Spremenjeno iz absolute v fixed, da deluje na celotnem viewportu */
            width: 10px;
            height: 10px;
            background-color: #f0f;
            animation: fall linear infinite;
            border-radius: 50%;
        }
        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0.5; }
        }

        .game-button {
            transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.1);
        }

        /* Postavitev gumbov za mobilne naprave */
        #gameScreen .flex.space-x-4 {
            display: flex;
            flex-wrap: wrap; /* Omogoƒçi prehod v novo vrsto na manj≈°ih zaslonih */
            gap: 0.5rem; /* Razmik med gumbi */
            justify-content: center; /* Centriranje gumbov */
            width: 100%;
            max-width: 600px;
        }
        
        #gameScreen .flex.space-x-4 > button {
            flex-grow: 1; /* Omogoƒçi, da gumbi zasedejo preostali prostor */
            min-width: 120px; /* Minimalna ≈°irina gumba */
        }

        /* Prilagodi gumbe za Nazaj in Domov, da se bolje prilegajo */
        @media (max-width: 640px) {
            #gameScreen .flex.space-x-4 > button {
                padding: 0.5rem 0.75rem; /* Zmanj≈°an padding */
                font-size: 0.875rem; /* Manj≈°a pisava (sm:text-base) */
                min-width: 45%; /* Da gresta dva v vrsto (45% + gap) */
            }
            /* Gumb 'Naslednji' naj ostane v svoji vrsti ali se lepo prilega */
            #nextItemButton {
                min-width: 100%; /* Na mobilnih naj zasede celo ≈°irino */
            }
        }
    </style>

</head>
<body>

<audio id="successSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_249007ae08.mp3" preload="auto"></audio>
<audio id="rocketSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_b287413669.mp3" preload="auto"></audio>
<audio id="prizeSound" src="https://cdn.pixabay.com/audio/2022/03/10/audio_f551b96a84.mp3" preload="auto"></audio>

<div class="main-content-wrapper">
    <header class="text-center mb-8 w-full max-w-xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-indigo-700">Pustolov≈°ƒçina Sledenja za Malƒçke</h1>
        <p id="instructionText" class="text-gray-600 mt-2 text-lg sm:text-xl font-medium">Vnesite ime in izberite kategorijo!</p>
    </header>

    <div id="categoryScreen" class="flex flex-col space-y-4 w-full max-w-sm">
        <input type="text" id="childNameInput" placeholder="Vnesite ime otroka"
                class="w-full text-center p-3 text-lg border-2 border-indigo-500 rounded-xl mb-4 focus:outline-none focus:ring-4 focus:ring-indigo-300"
                value=""
                oninput="updateChildName()"/>

        <button onclick="handleCategorySelection('Letters')" class="game-button bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out">
            üÖ∞Ô∏èüÖ±Ô∏è ABC ƒårke (Tiskane in Pisane)
        </button>
        <button onclick="handleCategorySelection('Numbers')" class="game-button bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out">
            1Ô∏è‚É£2Ô∏è‚É£ ≈†tevila (1-1000, poljuben obseg)
        </button>
        <button onclick="handleCategorySelection('Shapes')" class="game-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out">
            üî∫üîµ Oblici (Izberite podkategorijo)
        </button>
    </div>
    
    <div id="numberSelectionScreen" class="hidden flex-col space-y-4 w-full max-w-sm">
        <button onclick="showCategories()" class="game-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-sm sm:text-base mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
            Nazaj na kategorije
        </button>

        <label class="text-lg font-medium text-gray-700 text-center">Izberite obseg ≈°tevilk (1 - 1000):</label>
        <div class="flex space-x-2">
            <input type="number" id="startNumberInput" placeholder="Od (npr. 1)" value="1" min="1" max="1000"
                    class="w-1/2 p-3 text-lg border-2 border-green-500 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-300 text-center"/>
            <input type="number" id="endNumberInput" placeholder="Do (npr. 10)" value="10" min="1" max="1000"
                    class="w-1/2 p-3 text-lg border-2 border-green-500 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-300 text-center"/>
        </div>
        <div id="numberError" class="text-red-600 font-medium text-center hidden"></div>
        <button onclick="startGame('Numbers')" class="game-button bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out mt-4">
            Zaƒçni!
        </button>
    </div>
    
    <div id="shapeSelectionScreen" class="hidden flex-col space-y-4 w-full max-w-sm">
        <button onclick="showCategories()" class="game-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-sm sm:text-base mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
            Nazaj na kategorije
        </button>
        <label class="text-lg font-medium text-gray-700 text-center">Izberite vrsto oblik (10 sekund na obliko):</label>
        
        <button onclick="startGame('GEOMETRIC_SHAPES')" class="game-button bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out">
            üî∫üîµ Geometrijske Oblike (Krog, Kvadrat, Trikotnik...)
        </button>
        <button onclick="startGame('ELEMENTS')" class="game-button bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out">
            ‚≠ê‚ù§Ô∏è Razliƒçni Elementi (Zvezda, Srce, Pu≈°ƒçice...)
        </button>
    </div>


    <div id="gameScreen" class="hidden w-full flex-grow flex flex-col items-center justify-start p-4">
        <div id="messageBox" class="text-center mb-4 p-3 rounded-xl font-bold text-lg hidden w-full max-w-sm" role="alert"></div>

        <div class="canvas-container">
            <div id="countdownTimer" class="absolute top-2 right-2 text-xl font-bold text-red-500 z-50 p-2 bg-white rounded-lg shadow-md hidden"></div>
            
            <div id="targetDisplay"></div>
            <canvas id="drawingCanvas"></canvas>
            
            <div id="successOverlay">
                <svg id="checkIcon" xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-green-500 success-icon" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                
                <svg id="rocketIcon" xmlns="http://www.w3.org/2000/svg" class="w-28 h-28 text-indigo-600 success-icon mt-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <defs>
                        <linearGradient id="rocketFire" x1="12" y1="20" x2="12" y2="24" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#fcd34d" /> 
                            <stop offset="50%" stop-color="#ef4444" /> 
                            <stop offset="100%" stop-color="#be123c" /> 
                        </linearGradient>
                    </defs>
                    
                    <path fill="#9d9d9d" d="M12 2L9 6h6l-3-4z"/>
                    <path fill="#cccccc" d="M9 6h6v10H9V6z"/>
                    <path fill="#9d9d9d" d="M8 10h-2l1-4h3l-2 4zM16 10h2l-1-4h-3l2 4z"/>
                    
                    <circle cx="12" cy="9" r="2" fill="#4a90e2"/>
                    
                    <path fill="#7d7d7d" d="M8 16h-4l2 4h2l-2-4zM16 16h4l-2 4h-2l2-4z"/>
                    
                    <path fill="url(#rocketFire)" d="M11 16c0 2 1 4 1 6s1-4 1-6h-2z" />
                    <path fill="url(#rocketFire)" d="M10 17c0 1.5 1 3 2 5s2-3.5 2-5h-4z" />
                </svg>

                <div id="confettiText" class="absolute hidden">
                    BRAVO, <span id="confettiChildName"></span>! KONEC IGRE!
                </div>
            </div>
        </div>

        <div class="flex space-x-4 mt-8">
            <button onclick="clearCanvas()" class="game-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                </svg>
                Poƒçisti
            </button>
            <button id="nextItemButton" onclick="manualNextItem()" class="game-button bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.02 8.72a1 1 0 01.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                Naslednji (Preskok)
            </button>
            <button onclick="showCategories()" class="game-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                Domov
            </button>
            <button onclick="goBack()" class="game-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Nazaj
            </button>
        </div>
    </div>
</div> <script>
    // --- Global Variables and Setup ---
    const ALPHABET_PRINTED = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'ƒå', '≈†', '≈Ω', 'ƒç', '≈°', '≈æ'];
    const MAX_NUMBER = 1000;
    const NUMBERS_ITEMS_FULL = Array.from({length: MAX_NUMBER}, (_, i) => (i + 1).toString()); 
    const GEOMETRIC_SHAPES = ['‚óã', '‚òê', '‚ñ≥', '‚ñΩ', '‚óá', '‚¨ü', '‚¨¢', '‚¨°', '‚¨ß', '‚¨¶', '‚¨ö', '‚¨£', '‚óø', '‚ó∫', '‚ó∏', '‚óπ', '‚óº', '‚óª', '‚ñ≤', '‚ñº', '‚óÑ', '‚ñ∫', '‚óÇ', '‚ñ∏', '‚óÜ', '‚óà'];
    const ELEMENTS = ['‚òÖ', '‚ù§Ô∏è', '‚òÅÔ∏è', '‚òÄÔ∏è', '‚≠ê', '‚ö°', '‚òÇÔ∏è', '‚ùÑÔ∏è', 'üé∂', 'üéµ', 'üè†', 'üçé', 'üîî', 'üìå', 'üí°', '‚ùì', '‚ùï', '‚ùó', '‚ûï', '‚ûñ', '‚ûó', '‚úñ'];
    const CURSIVE_UPPER = ['ùíú', 'ùêµ', 'ùíû', 'ùíü', 'ùê∏', 'ùêπ', 'ùí¢', 'ùêª', 'ùêº', 'ùí•', 'ùí¶', 'ùêø', 'ùëÄ', 'ùí©', 'ùí™', 'ùí´', 'ùí¨', 'ùëÖ', 'ùíÆ', 'ùíØ', 'ùí∞', 'ùí±', 'ùí≤', 'ùí≥', 'ùí¥', 'ùíµ'];
    const CURSIVE_LOWER = ['ùí∂', 'ùí∑', 'ùí∏', 'ùíπ', 'ùëí', 'ùíª', 'ùëî', 'ùíΩ', 'ùíæ', 'ùíø', 'ùìÄ', 'ùìÅ', 'ùìÇ', 'ùìÉ', 'ùëú', 'ùìÖ', 'ùìÜ', 'ùìá', 'ùìà', 'ùìâ', 'ùìä', 'ùìã', 'ùìå', 'ùìç', 'ùìé', 'ùìè'];
    const CURSIVE_SL_ADDONS = ['ƒå', '≈†', '≈Ω', 'ƒç', '≈°', '≈æ'];
    const ALL_LETTERS_COMBINED = ALPHABET_PRINTED.concat(CURSIVE_UPPER).concat(CURSIVE_LOWER).concat(CURSIVE_SL_ADDONS);

    const CATEGORIES = {
        'Letters': { items: ALL_LETTERS_COMBINED, passedItems: [] },
        'Numbers': { items: NUMBERS_ITEMS_FULL, passedItems: [] },
        'GEOMETRIC_SHAPES': { items: GEOMETRIC_SHAPES, passedItems: [] },
        'ELEMENTS': { items: ELEMENTS, passedItems: [] }
    };
    
    const ITEM_DURATION_SECONDS = 10;
    let itemTimer = null; 
    let countdownInterval = null; 
    let isTimerStarted = false; 
    let timeRemaining = ITEM_DURATION_SECONDS;
    const LS_PASS_KEY = 'tracingGamePasssedItems'; 

    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const targetDisplay = document.getElementById('targetDisplay');
    const instructionText = document.getElementById('instructionText');
    const messageBox = document.getElementById('messageBox');
    const childNameInput = document.getElementById('childNameInput');
    const startNumberInput = document.getElementById('startNumberInput');
    const endNumberInput = document.getElementById('endNumberInput');
    const numberErrorDiv = document.getElementById('numberError');
    const countdownTimerDisplay = document.getElementById('countdownTimer');

    const successOverlay = document.getElementById('successOverlay');
    const checkIcon = document.getElementById('checkIcon');
    const rocketIcon = document.getElementById('rocketIcon');
    const confettiText = document.getElementById('confettiText');
    const confettiChildName = document.getElementById('confettiChildName');
    
    const successSound = document.getElementById('successSound');
    const rocketSound = document.getElementById('rocketSound');
    const prizeSound = document.getElementById('prizeSound');

    let isDrawing = false;
    let currentCategory = null;
    let categoryKey = ''; 
    let childName = "";
    let lastCompletedItem = null; 
    let navigationHistory = []; 
    
    const CATEGORY_INSTRUCTION_TEXT = "Vnesite ime in izberite kategorijo!";
    
    let FemaleVoice = null;
    window.speechSynthesis.onvoiceschanged = () => {
        FemaleVoice = window.speechSynthesis.getVoices().find(voice => voice.lang === 'sl-SI' && (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('≈æena')));
        if (!FemaleVoice) {
            FemaleVoice = window.speechSynthesis.getVoices().find(voice => voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('≈æena'));
        }
    };


    function safePlay(audioElement) {
        if (!audioElement) return;
        audioElement.pause();
        audioElement.currentTime = 0;
        
        const playPromise = audioElement.play();

        if (playPromise !== undefined) {
            playPromise.then(_ => {
            }).catch(error => {
                console.warn("Audio playback blocked or failed. User interaction might be required.", error);
            });
        }
    }
    
    function speak(text) {
        if (!('speechSynthesis' in window)) {
            console.log("Govorna sinteza ni podprta v tem brskalniku.");
            return;
        }
        window.speechSynthesis.cancel(); 
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'sl-SI';
        if (FemaleVoice) {
            utterance.voice = FemaleVoice;
        } else {
             utterance.lang = 'sl-SI'; 
        }
        
        setTimeout(() => {
             window.speechSynthesis.speak(utterance);
        }, 100); 
    }
    
    let confettiInterval = null;
    const confettiColors = ['#f0f', '#0ff', '#ff0', '#0f0', '#f00', '#00f'];

    function createConfetti() {
        const piece = document.createElement('div');
        piece.classList.add('confetti');
        piece.style.left = `${Math.random() * 100}vw`;
        piece.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
        piece.style.animationDuration = `${Math.random() * 2 + 1}s`;
        piece.style.opacity = Math.random().toString();
        document.body.appendChild(piece);

        setTimeout(() => {
            piece.remove();
        }, 3000); 
    }

    function startConfetti() {
        confettiInterval = setInterval(createConfetti, 50);
        setTimeout(stopConfetti, 3500);
    }

    function stopConfetti() {
        clearInterval(confettiInterval);
        confettiInterval = null;
        document.querySelectorAll('.confetti').forEach(c => c.remove());
    }
    
    function saveGameProgress(key, itemsToSave) {
        if (!key) return;
        
        const savedProgress = JSON.parse(localStorage.getItem(LS_PASS_KEY) || '{}');
        savedProgress[key] = itemsToSave; 
        localStorage.setItem(LS_PASS_KEY, JSON.stringify(savedProgress));
    }

    function loadGameProgress(key) {
        if (!key) return [];
        
        const savedProgress = JSON.parse(localStorage.getItem(LS_PASS_KEY) || '{}');
        return savedProgress[key] || [];
    }

    function getRandomItem(sourceArray, passedArray) {
        const remainingItems = sourceArray.filter(item => !passedArray.includes(item));
        if (remainingItems.length === 0) return null;

        const randomIndex = Math.floor(Math.random() * remainingItems.length);
        return remainingItems[randomIndex];
    }
    
    function startCountdown(duration) {
        stopCountdown();

        timeRemaining = duration;
        countdownTimerDisplay.textContent = `Preostali ƒças: ${timeRemaining}s`;
        countdownTimerDisplay.classList.remove('hidden');
        isTimerStarted = true; 

        itemTimer = setTimeout(() => {
            stopCountdown();
            triggerSuccessAnimationAndNextItem(); 
        }, duration * 1000);

        countdownInterval = setInterval(() => {
            timeRemaining--;
            if (timeRemaining >= 0) {
                 countdownTimerDisplay.textContent = `Preostali ƒças: ${timeRemaining}s`;
            } else {
                clearInterval(countdownInterval);
            }
        }, 1000);
    }

    function stopCountdown() {
        if (itemTimer) clearTimeout(itemTimer);
        if (countdownInterval) clearInterval(countdownInterval);
        itemTimer = null;
        countdownInterval = null;
        isTimerStarted = false; 
        countdownTimerDisplay.classList.add('hidden');
    }

    function updateChildName() {
        childName = childNameInput.value.trim();
        localStorage.setItem('childName', childName);
    }

    function showCategories() {
        if (currentCategory && categoryKey && lastCompletedItem && !currentCategory.passedItems.includes(lastCompletedItem)) {
            currentCategory.passedItems.push(lastCompletedItem);
            saveGameProgress(categoryKey, currentCategory.passedItems);
        }
        
        document.getElementById('gameScreen').classList.add('hidden');
        document.getElementById('numberSelectionScreen').classList.add('hidden');
        document.getElementById('shapeSelectionScreen').classList.add('hidden');
        document.getElementById('categoryScreen').classList.remove('hidden');
        
        stopCountdown(); 
        
        const nameToUse = childName || 'Prijatelj';
        instructionText.textContent = `Dobrodo≈°el, ${nameToUse}! Izberi kategorijo!`;

        messageBox.classList.add('hidden');
        numberErrorDiv.classList.add('hidden');
        successOverlay.style.opacity = 0; 
        stopConfetti(); 
        
        currentCategory = null; 
        categoryKey = '';
        lastCompletedItem = null;
        navigationHistory = []; 
    }
    
    function goBack() {
        if (currentCategory && categoryKey && lastCompletedItem && !currentCategory.passedItems.includes(lastCompletedItem)) {
            currentCategory.passedItems.push(lastCompletedItem);
            saveGameProgress(categoryKey, currentCategory.passedItems);
        }
        
        stopCountdown();
        
        const lastScreen = navigationHistory.pop();
        
        document.getElementById('gameScreen').classList.add('hidden');
        document.getElementById('numberSelectionScreen').classList.add('hidden');
        document.getElementById('shapeSelectionScreen').classList.add('hidden');

        if (lastScreen === 'numberSelectionScreen') {
            document.getElementById('numberSelectionScreen').classList.remove('hidden');
            instructionText.textContent = `Izberi obseg za ≈†tevilke (10 sekund na ≈°tevilko)!`; 
        } else if (lastScreen === 'shapeSelectionScreen') {
            document.getElementById('shapeSelectionScreen').classList.remove('hidden');
            instructionText.textContent = `Izberi vrsto oblik, ki jo ≈æeli≈° slediti!`; 
        } else {
            showCategories(); 
        }
        
        lastCompletedItem = null;
        currentCategory = null;
        categoryKey = '';
    }

    function handleCategorySelection(key) {
        if (key === 'Numbers') {
            document.getElementById('categoryScreen').classList.add('hidden');
            document.getElementById('numberSelectionScreen').classList.remove('hidden');
            instructionText.textContent = `Izberi obseg za ≈†tevile (10 sekund na ≈°tevilko)!`; 
            navigationHistory.push('categoryScreen');
        } else if (key === 'Shapes') {
            document.getElementById('categoryScreen').classList.add('hidden');
            document.getElementById('shapeSelectionScreen').classList.remove('hidden');
            instructionText.textContent = `Izberi vrsto oblik, ki jo ≈æeli≈° slediti!`; 
            navigationHistory.push('categoryScreen');
        } else if (key === 'Letters') { 
            navigationHistory.push('categoryScreen'); 
            startGame('Letters');
        } else {
            
            if (document.getElementById('numberSelectionScreen').classList.contains('hidden') === false) {
                 navigationHistory.push('numberSelectionScreen');
            } else if (document.getElementById('shapeSelectionScreen').classList.contains('hidden') === false) {
                 navigationHistory.push('shapeSelectionScreen');
            }
            startGame(key);
        }
    }

    function startGame(key) {
        if (key === 'Letters') currentCategory = CATEGORIES.Letters; 
        else if (key === 'GEOMETRIC_SHAPES') currentCategory = CATEGORIES.GEOMETRIC_SHAPES;
        else if (key === 'ELEMENTS') currentCategory = CATEGORIES.ELEMENTS;
        else if (key === 'Numbers') {
            currentCategory = CATEGORIES.Numbers;
            
            let start = parseInt(startNumberInput.value);
            let end = parseInt(endNumberInput.value);

            if (isNaN(start) || isNaN(end) || start < 1 || end > MAX_NUMBER || start > end) {
                numberErrorDiv.textContent = "Neveljaven obseg. Od (1) mora biti manj≈°i od Do (1000).";
                numberErrorDiv.classList.remove('hidden');
                return; 
            }
            numberErrorDiv.classList.add('hidden');
            
            currentCategory.items = NUMBERS_ITEMS_FULL.slice(start - 1, end);
            document.getElementById('numberSelectionScreen').classList.add('hidden');
        }

        categoryKey = key;
        
        currentCategory.passedItems = loadGameProgress(key); 

        document.getElementById('categoryScreen').classList.add('hidden');
        document.getElementById('shapeSelectionScreen').classList.add('hidden');
        document.getElementById('numberSelectionScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');

        initializeCanvas(key); 
        displayNextRandomItem(); 
    }

    function displayNextRandomItem() {
        const nextItem = getRandomItem(currentCategory.items, currentCategory.passedItems);
        
        stopCountdown(); 

        if (nextItem === null) {
            saveGameProgress(categoryKey, []); 
            triggerEndGameAnimation();
            return;
        }

        lastCompletedItem = nextItem; 
        targetDisplay.textContent = nextItem;
        
        const namePart = childName ? `, ${childName}` : '';
        instructionText.textContent = `Pripravi se na sledenje **${nextItem}**${namePart}! Zaƒçni risati, da za≈æene≈° ${ITEM_DURATION_SECONDS}-sekundni ƒçasovnik.`;
        
        const isCursive = CURSIVE_UPPER.includes(nextItem) || CURSIVE_LOWER.includes(nextItem);
        
        if (isCursive) {
             targetDisplay.classList.add('cursive-font');
        } else {
             targetDisplay.classList.remove('cursive-font');
        }
        
        clearCanvas();
    }
    
    function initializeCanvas(key) {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;

        if (key === 'ELEMENTS') {
             ctx.lineWidth = 8; 
        } else {
             ctx.lineWidth = 14; 
        }
        
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#4f46e5';
        clearCanvas();
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (currentCategory && document.getElementById('gameScreen').classList.contains('hidden') === false) {
            stopDrawing();
            stopCountdown(); 
            
            const currentItem = targetDisplay.textContent;
            const namePart = childName ? `, ${childName}` : '';
            instructionText.textContent = `Risanje poƒçi≈°ƒçeno. Zaƒçni ponovno sledenje **${currentItem}**${namePart}, da za≈æene≈° ${ITEM_DURATION_SECONDS}-sekundni ƒçasovnik.`;
            
            messageBox.classList.add('hidden');
        } else {
            messageBox.classList.add('hidden');
        }
    }

    function getMousePos(event) {
        const rect = canvas.getBoundingClientRect();
        const clientX = event.clientX !== undefined ? event.clientX : event.touches[0].clientX;
        const clientY = event.clientY !== undefined ? event.clientY : event.touches[0].clientY;
        
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDrawing(event) {
        isDrawing = true;
        const pos = getMousePos(event);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        event.preventDefault();

        if (!isTimerStarted) {
            startCountdown(ITEM_DURATION_SECONDS);
             const namePart = childName ? `, ${childName}` : '';
             instructionText.textContent = `Ri≈°ite in sledite **${targetDisplay.textContent}**${namePart}! Preostali ƒças: ${ITEM_DURATION_SECONDS}s`;
        }
    }

    function draw(event) {
        if (!isDrawing) return;
        const pos = getMousePos(event);
        
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        
        event.preventDefault();
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.closePath();
    }

    function manualNextItem() {
        if (!currentCategory) return;
        
        stopDrawing();
        stopCountdown(); 
        triggerSuccessAnimationAndNextItem();
    }
    
    function triggerSuccessAnimationAndNextItem() {
        if (successOverlay.style.opacity == 1) return;

        stopCountdown(); 

        checkIcon.classList.remove('success-icon-animate');
        rocketIcon.classList.remove('rocket-animate');
        checkIcon.style.opacity = 0;
        rocketIcon.style.opacity = 0;
        confettiText.classList.add('hidden'); 

        successOverlay.style.opacity = 1;
        checkIcon.classList.add('success-icon-animate');
        safePlay(successSound); 
        
        setTimeout(() => {
            targetDisplay.textContent = ''; 

            checkIcon.classList.remove('success-icon-animate'); 
            checkIcon.style.opacity = 0;

            rocketIcon.classList.add('rocket-animate'); 
            safePlay(rocketSound); 
            
            if (lastCompletedItem) {
                if (!currentCategory.passedItems.includes(lastCompletedItem)) {
                    currentCategory.passedItems.push(lastCompletedItem);
                }
                saveGameProgress(categoryKey, currentCategory.passedItems); 
            }

            setTimeout(() => {
                successOverlay.style.opacity = 0;
                rocketSound.pause(); 
                displayNextRandomItem();
                
            }, 2000); 
            
        }, 1000); 
    }

    function triggerEndGameAnimation() {
        document.getElementById('gameScreen').classList.add('hidden');

        successOverlay.style.opacity = 1;
        checkIcon.style.opacity = 0;
        rocketIcon.style.opacity = 0;
        
        confettiText.classList.remove('hidden');
        confettiChildName.textContent = childName || 'Prijatelj';
        
        safePlay(prizeSound); 
        startConfetti();

        setTimeout(() => {
            showCategories(); 
            prizeSound.pause();
        }, 4000);
    }
    
    // --- EVENT LISTENERS in ZAGON APLIKACIJE ---
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    // Vsi touch eventi so kljuƒçni za mobilni naƒçin
    canvas.addEventListener('touchstart', startDrawing, {passive: false});
    canvas.addEventListener('touchmove', draw, {passive: false});
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);

    window.addEventListener('resize', initializeCanvas);

    document.addEventListener('DOMContentLoaded', () => {
        const savedName = localStorage.getItem('childName');
        if (savedName) {
            childNameInput.value = savedName;
            childName = savedName;
        }

        updateChildName();
        showCategories();
        
        const nameToSpeak = childName || 'Prijatelj';
        speak(`Dobrodo≈°el, ${nameToSpeak}! Zdaj si v pustolov≈°ƒçini sledenja! Izberi kategorijo!`);

        initializeCanvas('Letters'); 
    });

</script>
</body>
</html>
